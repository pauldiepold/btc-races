# BTC Wettkampfanmeldung

Eine moderne Anwendung zur Verwaltung von Wettkampfanmeldungen f√ºr die BTC-Vereinsmitglieder.

## Funktionen

- **Wettkampfverwaltung**: Erstellen, Bearbeiten und L√∂schen von Wettk√§mpfen
- **Anmeldungsprozess**: Einfacher Anmeldeprozess mit E-Mail-Best√§tigung
- **Mitgliederverwaltung**: Excel-Import und Mitgliederverwaltung
- **Benachrichtigungssystem**: Automatisierte E-Mail-Benachrichtigungen
- **Authentifizierung**: Microsoft Entra ID Integration f√ºr Admins

## Technologie-Stack

- **Frontend**: Nuxt 3 mit Vue 3
- **UI-Framework**: Nuxt UI
- **Backend-Datenbank**: Supabase (PostgreSQL)
- **Hosting**: Vercel
- **Auth**: Microsoft-Entra
- **E-Mail-Provider**: Microsoft Azure

## Einrichtung

### Voraussetzungen

- Node.js 18 oder h√∂her
- npm
- Supabase-Konto (kostenloser Tier ausreichend)

### Installation

1. Repository klonen

2. Abh√§ngigkeiten installieren

   ```bash
   npm install
   ```

3. Umgebungsvariablen konfigurieren

   ```bash
   cp .env.example .env
   ```

   Bearbeite die `.env`-Datei und f√ºge deine Supabase-Zugangsdaten ein.

4. Supabase-Projekt einrichten

   - Erstelle ein neues Projekt auf [Supabase](https://supabase.com)
   - F√ºhre das Schema aus `server/db/schema.sql` in der SQL-Konsole von Supabase aus
   - Kopiere die URL und den API-Key in deine `.env`-Datei

5. Entwicklungsserver starten
   ```bash
   npm run dev
   ```

## N√§chste Schritte f√ºr die Entwicklung

### Notwendig:

- ‚úÖ Competitions bearbeiten k√∂nnen
- ‚úÖ Neue Felder auf Competitions + Filter auf √úbersicht:
  - ‚úÖmeldepflichtig
  - ‚úÖ Meisterschaft
  - ‚úÖ Track / Road
- ‚úÖ Favicon hinzugef√ºgt, Metadaten angepasst, Navbar und Footer aufger√§umt
- ‚úÖ Layout anpassen + Transitions hinzuf√ºgen
- ‚úÖ E-Mails:
  - ‚úÖ mit Microsoft Azure verbunden
  - ‚úÖ Templating hinzugef√ºgt, noch nicht getestet
  - ‚úÖ Best√§tigungsmail nach Anmeldung mit Verifizierungslink
  - ‚úÖ Von Wettk√§mpfen wieder abmelden k√∂nnen
- ‚úÖ nicht bei Events anmelden k√∂nnen, bei denen die Anmeldefrist vergangen ist
- ‚úÖ Startpass importieren aus Campai
  - ‚úÖ Anmeldung bei meldepflichtigen Events sperren
- ‚ùå Echte Daten zu den Wettk√§mpfen importieren --> von LADV importieren
- ‚úÖ Beschreibungen √ºberall anpassen:
  - ‚úÖ Register: Falls du keinen Startpass hast... --> rechts in der Sidebar evt. noch die Kurzinfos zum Wettkampf anzeigen
  - ‚úÖ Ist die Startseite ausreichend?

### Bonus:

- ‚ùå User k√∂nnen selbst Wettk√§mpfe einstellen --> Freischaltung durch Admins notwendig?
- ‚ùå Light-Mode wieder aktivieren und Design etwas verbessern
- ‚ùå Nach Anmeldung sofort ohne Timeout weiterleiten und zur neuen Anmeldung scrollen + gr√ºn aufblinken lassen (bzw. sowieso die neusten oben anzeigen)
- ‚ùåAdmin: Nachrichten an alle Teilnehmer:innen senden k√∂nnen
- ‚ùåDatum f√ºr Erinnerungs-Mails einstellen k√∂nnen?
- Daten zu den Wettk√§mpfen erweitern:
  - üü° Distanzen --> Tabelle angelegt, noch nirgendwo verwendet --> Disziplincodes aus LADV verwenden
- E-Mail Erg√§nzungen:
  - ‚ùå Erinnerungsmail an Mitglieder 5 Tage vor Meldefrist mit Abmeldelink
  - ‚ùå Erinnerungsmail an Admins 3 Tage vor Meldefrist
  - ‚ùå Erinnerungsmail an teilnehmende Mitglieder 3 Tage vor dem Wettkampf
  - ‚ùå Nachfrage-E-Mail nach 3 Tagen bei nicht best√§tigten Anmeldungen
  - ‚ùå Cronjobs f√ºr Erinerungsmails

### Code-Qualit√§t:

- ‚úÖ Typen sortieren, gerade bei den Api Responses und Models ist etwas Chaos
- ‚úÖ Alle Supabase Abfragen in einen Service auslagern, Client + Serverseitig trennen?

## Mit der Datenbank arbeiten

### Neue Datenfelder hinzuf√ºgen:

1. Neue Migration erstellen:

   ```bash
   npx supabase migration new migration_name
   ```

2. In die neue leere Datei die gew√ºnschte √Ñnderung schreiben

3. Lokale Datenbank zur√ºcksetzen (l√∂scht die Datenbank, f√ºhrt alle Migrationen aus und f√ºhrt das Seeding aus):

   ```bash
   npx supabase db reset
   ```

   Falls kein komplette Reset gew√ºnscht ist, kann auch nurdie Migration ausgef√ºhrt werden:

   ```bash
   npx supabase migration up
   ```

4. Aus der lokalen Supabase-Konsole (http://127.0.0.1:54323/) m√ºssen die Database.types erneut heruntergeladen werden: Unter API Docs / TABLES AND VIEWS / Introduction / Generate and download types kann die Datei heruntergeladen werden und muss `~/types/database.types.ts` ersetzen.

5. Zuletzt muss das Seeding angepasst werden. Am einfachsten per AI und die √Ñnderung beschreiben.

6. Solange die Migration noch nicht in der Prod-Datenbank vorhanden ist, kann sie noch ver√§ndert werden und mit `npx supabase db reset` getestet werden. Sobald die Entwicklung abgeschlossen ist, kann sie auf die remote Datenbank gepusht werden:

   ```bash
   npx supabase db push
   ```

   Zuvor muss einmalig folgendes ausgef√ºhrt werden:

   ```bash
   npx supabase login
   npx supabase link
   ```

# Repository-System

## Struktur

Das Repository-System bietet eine konsistente API f√ºr den Zugriff auf Datenbanktabellen. Es umfasst:

### Basisklassen

- **BaseRepository**: Grundfunktionalit√§t f√ºr alle Repositories
- **ClientRepository**: F√ºr Client-seitige Verwendung (im Browser)
- **ServerRepository**: F√ºr Server-seitige Verwendung (API-Routen)
- **ServiceRoleRepository**: F√ºr Server-seitige Verwendung mit administrativen Rechten

### Konkrete Implementierungen

Jede Tabelle hat in der Regel drei spezialisierte Repository-Klassen:

- **[Name]ClientRepository**: F√ºr Browser-Zugriff
- **[Name]ServerRepository**: F√ºr normalen Server-Zugriff
- **[Name]ServiceRepository**: F√ºr Server-Zugriff mit erh√∂hten Rechten

### Factory-Funktionen

Anstatt statische Methoden f√ºr jede Klasse zu implementieren, verwenden wir spezialisierte Factory-Funktionen:

```typescript
// Erstellen eines Server-Repositories
const sentEmails = await createSentEmailsServerRepository(event)

// Erstellen eines ServiceRole-Repositories
const sentEmails = await createSentEmailsServiceRepository(event)
```

## Verwendung

### Client-seitig

Mit dem `useRepositories` Composable:

```typescript
// In einer Vue-Komponente
const { sentEmails } = useRepositories()

// Daten abfragen
const email = await sentEmails.findByToken('token123')
```

### Server-seitig

Mit dem `createServerRepositories` Helfer:

```typescript
// In einem API-Handler
export default defineEventHandler(async (event) => {
  const { sentEmails } = await createServerRepositories(event)

  // Mit normalen Nutzerrechten arbeiten
  const emails = await sentEmails.findAll()

  return { emails }
})
```

### Mit administrativen Rechten

```typescript
// In einem API-Handler
export default defineEventHandler(async (event) => {
  const { sentEmails } = await createServerRepositories(event, true)

  // Mit administrativen Rechten arbeiten
  await sentEmails.createWithoutRLS({ ... })

  return { success: true }
})
```

## LADV-Integration

Die Anwendung unterst√ºtzt die Integration mit dem [LADV-System](https://ladv.de/entwickler) (Leichtathletik-Verband Baden-W√ºrttemberg). Dies erm√∂glicht das automatische Importieren von Wettkampfdaten aus dem LADV-System.

### Funktionalit√§t

- **Automatischer Import**: Wettk√§mpfe k√∂nnen √ºber ihre LADV-ID importiert werden
- **Daten-Synchronisation**: Automatische Aktualisierung der Wettkampfdaten
- **Mock-Modus**: Entwicklung und Tests ohne API-Zugriff m√∂glich

### Konfiguration

Die Integration wird √ºber Umgebungsvariablen konfiguriert:

```env
NUXT_LADV_PROVIDER=mock|api  # Standard: mock
NUXT_LADV_API_KEY=your-key   # Nur f√ºr API-Modus erforderlich
```

### Technische Details

- **API-Dokumentation**: [LADV API V2 Dokumentation](https://html.ladv.de/api/2024-07-17-LADVAPIDokumentation-V2-014.pdf)
- **Datenmodell**: Erweiterung der `competitions`-Tabelle um LADV-spezifische Felder
- **Mock-Daten**: Realistische Testdaten f√ºr Entwicklung und Tests

### Verwendung

```typescript
import { LadvService } from '~/server/ladv'

const ladvService = new LadvService()

// Wettkampfdetails abrufen
const competition = await ladvService.getCompetitionDetails(123)

// Nach Wettk√§mpfen suchen
const competitions = await ladvService.searchCompetitions('Stuttgart')
```
